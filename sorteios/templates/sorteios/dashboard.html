{% extends 'sorteios/base.html' %}
{% load humanize %}

{% block title %}Dashboard - EuroMilhões Analyzer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
    {% if ultimo_sorteio %}
    <span class="badge bg-primary fs-6">
        Último sorteio: {{ ultimo_sorteio.data|date:"d/m/Y" }}
    </span>
    {% endif %}
</div>

<!-- Último Sorteio -->
{% if ultimo_sorteio %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Último Sorteio - {{ ultimo_sorteio.data|date:"d/m/Y" }}</h5>
    </div>
    <div class="card-body text-center">
        <div class="mb-3">
            {% for num in ultimo_sorteio.get_numeros %}
                <span class="numero-ball">{{ num|stringformat:"02d" }}</span>
            {% endfor %}
            <span class="mx-2 fs-4">+</span>
            {% for est in ultimo_sorteio.get_estrelas %}
                <span class="estrela-ball">{{ est|stringformat:"02d" }}</span>
            {% endfor %}
        </div>
        {% if ultimo_sorteio.jackpot %}
        <p class="mb-0">
            <strong>Jackpot:</strong> €{{ ultimo_sorteio.jackpot|floatformat:0|intcomma }}
            {% if ultimo_sorteio.houve_vencedor %}
                <span class="badge bg-success">Houve vencedor!</span>
            {% endif %}
        </p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Cards de Resumo -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-calendar-check fs-1 text-primary"></i>
                <h3 class="mt-2">{{ total_sorteios }}</h3>
                <p class="text-muted mb-0">Sorteios Analisados</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-fire fs-1 text-danger"></i>
                <h3 class="mt-2">
                    {% if numeros_quentes %}
                        {{ numeros_quentes.0.numero|stringformat:"02d" }}
                    {% else %}
                        --
                    {% endif %}
                </h3>
                <p class="text-muted mb-0">Número Mais Quente</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-snow fs-1 text-info"></i>
                <h3 class="mt-2">
                    {% if numeros_frios %}
                        {{ numeros_frios.0.numero|stringformat:"02d" }}
                    {% else %}
                        --
                    {% endif %}
                </h3>
                <p class="text-muted mb-0">Número Mais Frio</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-hourglass-split fs-1 text-warning"></i>
                <h3 class="mt-2">
                    {% if numeros_atrasados %}
                        {{ numeros_atrasados.0.numero|stringformat:"02d" }}
                    {% else %}
                        --
                    {% endif %}
                </h3>
                <p class="text-muted mb-0">Mais Atrasado</p>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Frequência dos Números (1-50)</h5>
            </div>
            <div class="card-body">
                <canvas id="chartNumeros" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-star me-2"></i>Frequência das Estrelas</h5>
            </div>
            <div class="card-body">
                <canvas id="chartEstrelas" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tabelas de Top Números -->
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-fire me-2"></i>Top 10 Quentes</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Freq.</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in numeros_quentes %}
                        <tr>
                            <td><span class="numero-ball small">{{ stat.numero|stringformat:"02d" }}</span></td>
                            <td>{{ stat.frequencia }}</td>
                            <td>{{ stat.percentagem }}%</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center text-muted">Sem dados</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-snow me-2"></i>Top 10 Frios</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Freq.</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in numeros_frios %}
                        <tr>
                            <td><span class="numero-ball small">{{ stat.numero|stringformat:"02d" }}</span></td>
                            <td>{{ stat.frequencia }}</td>
                            <td>{{ stat.percentagem }}%</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center text-muted">Sem dados</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-hourglass-split me-2"></i>Top 10 Atrasados</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Dias</th>
                            <th>Última</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in numeros_atrasados %}
                        <tr>
                            <td><span class="numero-ball small">{{ stat.numero|stringformat:"02d" }}</span></td>
                            <td>{{ stat.dias_sem_sair }}</td>
                            <td>{{ stat.ultima_aparicao|date:"d/m" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center text-muted">Sem dados</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Estrelas -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #FFD700, #ffc107); color: #333;">
                <h5 class="mb-0"><i class="bi bi-star-fill me-2"></i>Estrelas Quentes</h5>
            </div>
            <div class="card-body text-center">
                {% for stat in estrelas_quentes %}
                    <span class="estrela-ball" title="Frequência: {{ stat.frequencia }}">
                        {{ stat.estrela|stringformat:"02d" }}
                    </span>
                {% empty %}
                    <span class="text-muted">Sem dados</span>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-star me-2"></i>Estrelas Frias</h5>
            </div>
            <div class="card-body text-center">
                {% for stat in estrelas_frias %}
                    <span class="estrela-ball" title="Frequência: {{ stat.frequencia }}" 
                          style="opacity: 0.6;">
                        {{ stat.estrela|stringformat:"02d" }}
                    </span>
                {% empty %}
                    <span class="text-muted">Sem dados</span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Gráfico de Números
const ctxNumeros = document.getElementById('chartNumeros').getContext('2d');
new Chart(ctxNumeros, {
    type: 'bar',
    data: {
        labels: {{ numeros_labels|safe }},
        datasets: [{
            label: 'Frequência',
            data: {{ numeros_frequencias|safe }},
            backgroundColor: 'rgba(0, 51, 153, 0.7)',
            borderColor: 'rgba(0, 51, 153, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Gráfico de Estrelas
const ctxEstrelas = document.getElementById('chartEstrelas').getContext('2d');
new Chart(ctxEstrelas, {
    type: 'doughnut',
    data: {
        labels: {{ estrelas_labels|safe }},
        datasets: [{
            data: {{ estrelas_frequencias|safe }},
            backgroundColor: [
                '#FFD700', '#FFC107', '#FFB300', '#FFA000',
                '#FF8F00', '#FF6F00', '#F57C00', '#EF6C00',
                '#E65100', '#DD2C00', '#D50000', '#C51162'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: { boxWidth: 15 }
            }
        }
    }
});
</script>
{% endblock %}
